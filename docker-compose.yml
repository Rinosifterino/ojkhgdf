version: '3.8'

# Rede customizada para controle de IPs e para o DNS funcionar corretamente
networks:
  trabalho_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

services:
  # 1. Servidor DNS (Bind9)
  dns:
    build:
      context: ./dns
      dockerfile: Dockerfile
    container_name: RR_DNS
    networks:
      trabalho_net:
        ipv4_address: 172.20.0.10 # IP fixo para ser referenciado no arquivo de zona
    ports:
      - "53:53/udp" # Necessário para que o host possa usar este DNS
      - "53:53/tcp"
    cap_add:
      - NET_ADMIN # Permite o Bind9 rodar
    restart: always

  # 2. Banco de Dados (PostgreSQL)
  db:
    image: postgres:16-alpine
    container_name: db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: trabalho_db
    networks:
      trabalho_net:
        ipv4_address: 172.20.0.20 # IP fixo para o backend se conectar
    volumes:
      - db_data:/var/lib/postgresql/data
    restart: always

  # 3. Servidor de Sessão Centralizada (Redis)
  redis:
    image: redis:7-alpine
    container_name: redis
    networks:
      trabalho_net:
        ipv4_address: 172.20.0.30 # IP fixo para o backend se conectar
    volumes:
      - redis_data:/data
    restart: always

  # 4. Servidores de Aplicação (Backend + Frontend embutido) - 3 instâncias
  app1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: servidor_1
    hostname: servidor_1
    environment:
      NODE_ENV: production
      POSTGRES_HOST: db
      REDIS_HOST: redis
    networks:
      trabalho_net:
        ipv4_address: 172.20.0.11 # IP fixo para o Round Robin DNS
    depends_on:
      - db
      - redis
    restart: always

  app2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: servidor_2
    hostname: servidor_2
    environment:
      NODE_ENV: production
      POSTGRES_HOST: db
      REDIS_HOST: redis
    networks:
      trabalho_net:
        ipv4_address: 172.20.0.12 # IP fixo para o Round Robin DNS
    depends_on:
      - db
      - redis
    restart: always

  app3:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: servidor_3
    hostname: servidor_3
    environment:
      NODE_ENV: production
      POSTGRES_HOST: db
      REDIS_HOST: redis
    networks:
      trabalho_net:
        ipv4_address: 172.20.0.13 # IP fixo para o Round Robin DNS
    depends_on:
      - db
      - redis
    restart: always
    
  ubuntu_desktop:
      image: lscr.io/linuxserver/webtop:ubuntu-xfce
      container_name: meu_linux_grafico
      environment:
        - PUID=1000
        - PGID=1000
        - TZ=America/Sao_Paulo
      volumes:
        - ./config:/config
      ports:
        - "3000:3000" # Acessar via navegador em http://localhost:3000
      dns:
        - 172.20.0.10 # Aponta para o seu servidor Bind9
      networks:
        trabalho_net: # <--- CORRIGIDO: Deve ser a mesma rede dos outros serviços
      shm_size: "1gb" # Necessário para interface gráfica não travar
      depends_on:
        - dns

volumes:
  db_data:
  redis_data:
